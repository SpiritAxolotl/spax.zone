<!--

Version: 1.4
Description: Hello? Waiter? Cheese with my spaghetti code please!
Next Major Update: IDK LMAO

By CalmBubbles :)
haha now it's edited by spax:)

-->


<!DOCTYPE HTML>
<html manifest="manifest">
  <head>
    <meta name="theme-color" content="#306850">
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1 user-scalable=no">
    <meta property="og:title" content="Spax Day">
    <meta property="og:description" content="Happy birthday Spax">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://calmbubbles.github.io/zerasGift/img/giftBox.png" type="image/png">
    <link rel="icon" href="https://calmbubbles.github.io/zerasGift/img/giftBox.png">
    
    <link rel="stylesheet" href="/css/styles.css" type="text/css">
    <link rel="stylesheet" href="/css/game.css" type="text/css">
    <title>Happy Birthday Spax</title>
    
    <style>

* {
  scrollbar-color : #86c06c #071821;
}

body {
  margin: 0;
}

video {
  pointer-events: none;
  width: 100%;
  height: 100%;
  object-fit: contain;
  -webkit-filter: contrast(110%);
}

#bg {
  overflow: clip;
  display: flex;
}

#tip {
  user-select: none;
  position: fixed;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 419;
  display: flex;
  flex-direction: column;
  background: #071821;
  color: #e0f8cf;
  pointer-events: all;
  transition: opacity 0.5s;
}

#tip div {
  position: relative;
  text-align: center;
  margin: auto;
  animation: linear fade 1s infinite;
  transition: opacity 0.5s;
}

#loading {
  width: 15vw;
  animation: fadeIn 1s;
  user-select: none;
  pointer-events: none;
}

#box {
  margin: auto;
}

#box[topped="1"] {
  margin: 0.5vw auto !important;
}

#box[data-enabled="false"] {
  transform: scaleY(0);
}

#ctrls {
  pointer-events: none;
  display: none;
  width: 100%;
  height: 37vh;
  bottom: 0;
  position: fixed;
  opacity: 0.75;
  font-size: 100px;
  align-items: center;
  justify-content: right;
  user-select: none;
  z-index: 418;
}

#ctrls div {
  pointer-events: all;
  position: absolute;
  width: 10vh;
  overflow: clip;
}

#ctrls .x {
  right: calc(10% + 12vh);
}

#ctrls .z {
  right: 10%;
}

#ctrls img {
  pointer-events: none;
  width: 200%;
}

#ctrls .z img {
  position: relative;
  right: 100%;
}

#ctrltext {
  pointer-events: none;
  user-select: none;
  position: fixed;
  bottom: 10px;
  right: 10px;
  z-index: 420;
  transition: opacity 0.25s;
  background: #071821;
  padding: 14px;
  padding-bottom: 10px;
}

#gift {
  background: black;
  width: 16vw;
  height: 16vw;
  margin: auto;
  margin-top: 1vw;
  margin-bottom: 20vh;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

#gift > div {
  position: absolute;
  margin: auto;
  overflow: clip;
  width: 13vw;
  display: flex;
}

#gift img {
  pointer-events: none;
  user-select: none;
  margin: auto;
  height: 13vw;
}

#gift div:nth-child(1) {
  z-index: 3;
}

#gift-hitbox div {
  cursor: grab;
}

#gift-hitbox[dragging="1"] div {
  cursor: grabbing;
}

#gift-hitbox div:nth-child(1) {
  position: absolute;
  width: 10.5vw;
  height: 5.25vw;
  top: 1.25vw;
  left: 1.25vw;
}

#gift-hitbox div:nth-child(2) {
  position: absolute;
  width: 5.25vw;
  height: 2.5vw;
}

#gift-hitbox div:nth-child(3) {
  position: absolute;
  width: 4vw;
  height: 2.5vw;
  left: 9vw;
}

#gift-trigger {
  background: #071821;
  width: auto !important;
  min-width: 8vw;
  min-height: 2.75vw;
  top: 4vw;
  z-index: 2 !important;
  display: block !important;
  cursor: zoom-in;
}

#gift-trigger[enabled="1"] {
  min-width: 100vw;
  min-height: 100vh;
  position: fixed;
  top: 0;
  bottom: 0;
  background: black;
  cursor: initial;
  z-index: 3 !important;
}

.textbox {
  margin: 0.5vw auto;
}

.change-0 {
  margin-top: 2.5px !important;
  margin-bottom: 2.5px !important;
}

.change-1 {
  margin-top: 15px !important;
  margin-bottom: 15px !important;
}

.change-2 {
  image-rendering: auto !important;
}

.change-2 * {
  image-rendering: pixelated !important;
}

.change-3 {
  border-width: calc(var(--scaler) * 8vw) !important;
  border-radius: calc(var(--scaler) * 6vw) !important;
  font-size: calc(var(--scaler) * 40vw) !important;
  line-height: calc(var(--scaler) * 56vw) !important;
}

.change-4 {
  margin: calc(var(--scaler) * 31vw) calc(var(--scaler) * 31vw) calc(var(--scaler) * 10vw) 0 !important;
}

@keyframes shake1 {

  0% { transform: translate(1px, 1px); }
  
  25% { transform: translate(-3px, 0px) rotate(1deg); }
  
  50% { transform: translate(-1px, 2px) rotate(-1deg); }
  
  75% { transform: translate(-1px, -1px) rotate(1deg); }
  
  100% { transform: translate(1px, -2px) rotate(-1deg); }
}

@keyframes shake2 {
  0% { transform: translate(2px, 2px); }
  
  25% { transform: translate(-6px, 0px) rotate(2deg); }
  
  50% { transform: translate(-2px, 4px) rotate(-2deg); }
  
  75% { transform: translate(-2px, -2px) rotate(2deg); }
  
  100% { transform: translate(2px, -4px) rotate(-2deg); }
}

@keyframes shake3 {
  0% { transform: translate(4px, 4px); }
  
  25% { transform: translate(-12px, 0px) rotate(4deg); }
  
  50% { transform: translate(-4px, 8px) rotate(-4deg); }
  
  75% { transform: translate(-4px, -4px) rotate(4deg); }
  
  100% { transform: translate(4px, -8px) rotate(-4deg); }
}

@keyframes shake4 {
  0% { transform: translate(8px, 8px) scale(1.5, 1); }
  
  25% { transform: translate(-24px, 0px) rotate(8deg); }
  
  50% { transform: translate(-8px, 16px) rotate(-8deg); }
  
  75% { transform: translate(-8px, -8px) rotate(8deg) scale(1, 2); }
  
  100% { transform: translate(8px, -16px) rotate(-8deg); }
}

@keyframes openBox {
  from { transform: scaleY(0); }

  to { transform: none; }
}

@keyframes fadeIn {
  from { opacity: 0; }
  
  to { opacity: 1; }
}

@keyframes fade {
  0% { opacity: 1; }
  
  50% { opacity: 0; }
  
  100% { opacity: 1; }
}

@media only screen and (max-width: 860px) {
  #loading { width: 50vw; }

  #box { margin-top: 50%; }

  #box[topped="1"] { margin-top: 2vw !important; }

  #ctrls { display: flex; }

  .textbox { --base-width: 98; }
}

@media only screen and (max-width: 860px) and (orientation: portrait) {
  #gift {
    width: 16vh;
    height: 16vh;
    margin-top: 1vh;
  }

  #gift div { width: 12.98vh; }
  
  #gift img { height: 13vh; }

  #gift-hitbox div:nth-child(1) {
    width: 10.5vh;
    height: 5.25vh;
    top: 1.25vh;
    left: 1.25vh;
  }

  #gift-hitbox div:nth-child(2) {
    width: 5.25vh;
    height: 2.5vh;
  }

  #gift-hitbox div:nth-child(3) {
    width: 4vh;
    height: 2.5vh;
    left: 9vh;
  }

  #gift-trigger {
    min-width: 8vh;
    min-height: 2.75vh;
    top: 4vh;
  }
}

@media only screen and (max-width: 860px) and (orientation: landscape) {
  #loading { width: 25vw; }

  #ctrls div { width: 10vw; }

  #ctrltext {
    left: 10px;
    right: initial;
  }

  #box { margin-top: 2vw; }

  #ctrls .x { right: calc(10% + 12vw); }
}

    </style>
  </head>

  <body>
    <div id="bg">
      <div id="tip"><div><noscript>This page requires JavaScript to work</noscript></div></div>

      <div id="box" class="textbox"></div>

      <div id="ctrls"><div class="x"><img src="/images/misc/ctrls.png"></div><div class="z"><img src="/images/misc/ctrls.png"></div></div>
      <div id="ctrltext">Z: Next&nbsp; X: Skip</div>
    </div>

    <script>

const tipText = tip.querySelector("div");
tipText.style.animation = "initial";

const loading = document.createElement("img");
loading.id = "loading";
loading.src = "/images/misc/loading.png";
tipText.append(loading);

const arrow = document.createElement("img");
arrow.classList.add("arrow");
arrow.style.display = "none";
arrow.src = "/images/misc/next_arrow.png";
box.append(arrow);

const ctrlX = ctrls.querySelector(".x");
const ctrlZ = ctrls.querySelector(".z");

    </script>
    <script src="https://calmbubbles.github.io/js-plugins/DialogueSystem.js" type="text/javascript"></script>
    <script src="https://calmbubbles.github.io/js-plugins/BetterAudio.js" type="text/javascript"></script>
    <script>

const diaManager = new DialogueManager(box);

diaManager.audioSource.volume = 0.7;

diaManager.config.audios = new DialogueAudioArray(
  [
    { name : "claire", src : "claire.ogg" },
    { name : "aimottle", src : "aimottle.ogg" },
    { name : "spax", src : "spax.ogg" },
    { name : "yoki", src : "yoki.ogg" },
    { name : "woof", src : "woof.ogg" },
    { name : "este", src : "este.ogg" },
    { name : "zera", src : "zera.ogg" }
  ],
  "/audio/dialogue"
)

diaManager.config.sprites = new DialogueSpriteArray(
  [
    { name : "claire/neutral", src : "claire/Neutral.png" },
    { name : "claire/happy", src : "claire/Happy.png" },
    { name : "claire/sigh", src : "claire/Sigh.png" },
    { name : "claire/aghast", src : "claire/Aghast.png" },
    { name : "claire/mad", src : "claire/Mad.png" },

    { name : "aimottle/unsure", src : "aimottle/Unsure.png" },
    { name : "aimottle/neutral", src : "aimottle/Neutral.png" },
    { name : "aimottle/angry", src : "aimottle/Angry.png" },

    { name : "spax/worried", src : "spax/Worried.png" },
    { name : "spax/pensive", src : "spax/Pensive.png" },
    { name : "spax/dizzy", src : "spax/Dizzy.png" },

    { name : "yoki/sweat_drop", src : "yoki/Sweat_Drop.png" },
    { name : "yoki/surprised", src : "yoki/Surprised.png" },

    { name : "woof/awake", src : "woof/Awake.png" },
    { name : "woof/look", src : "woof/Look.png" },

    { name : "este/", src : "este/Stare.png" },

    { name : "zera/neutral", src : "zera/Neutral.png" },
    { name : "zera/look", src : "zera/Look.png" },
    { name : "zera/sneer", src : "zera/Sneer.png" },
    { name : "zera/smile", src : "zera/Smile.png" },
    { name : "zera/pout", src : "zera/Pout.png" },
  ],
  "/images/faces"
);

// not a peep, added to preload
diaManager.config.sprites.items.push(
  new DialogueSprite("gift_cover", "https://calmbubbles.github.io/zerasGift/img/gift_cover.png"),
  new DialogueSprite("gift_base", "https://calmbubbles.github.io/zerasGift/img/gift_base.png")
);

diaManager.animation.box.onEnable.duration = 0.125;
diaManager.animation.box.onEnable.animation = "linear openBox";
diaManager.animation.box.onDisable.duration = 0.125;
diaManager.animation.box.onDisable.animation = "reverse linear openBox";

const bgm = [
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/bgm/yoki.ogg"),
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/bgm/zera.ogg"),
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/bgm/mansion.ogg")
];

bgm[0].loop = true;
bgm[1].loop = true;
bgm[2].loop = true;

const bgs = [
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/bgs/static.ogg")
];

bgs[0].loop = true;
bgs[0].volume = 0;

const me = [];

const se = [
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/se/tocrush.ogg"),
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/se/crush.ogg"),
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/se/gift_grab.ogg"),
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/se/gift_drop.ogg"),
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/se/drill.ogg"),
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/se/saw.ogg"),
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/se/cat.ogg"),
  new BetterAudio("https://calmbubbles.github.io/zerasGift/audio/se/hammer.ogg")
];

se[0].volume = 0.5;
se[1].volume = 0.7;
se[2].volume = 0.5;
se[3].volume = 0.75;
se[4].volume = 0.75;
se[5].volume = 0.5;
se[6].volume = 0.5;
se[7].volume = 0.7;

let diaNextValid = false;
let diaIndex = 0;
let canSkip = false;
let skipIndex = 0;
let skipSInterval = 0;
let skipHasAudio = false;
let bgAudio = null;
let bgLerping = false;
let giftVid = null;


class Input {
  static #keys = [];
  static #buttons = [];
  
  static #Key = class {
    active = false;
    lastState = false;
    isLetter = false;
    name = "";
    code = "";
    
    constructor (name, code, isLetter) {
      this.name = name;
      this.code = code;
      this.isLetter = isLetter ?? false;
    }
  }
  
  static #FindKeyByCode (code) {
    let output = -1;
    
    this.#keys.find((element, index) => {
      if (element.code !== (element.isLetter ? code.toLowerCase() : code)) return false;
      
      output = index;
      
      return true;
    });
    
    return output;
  }
  
  static Init () {
    this.#keys = [
      new this.#Key("z", "z", true),
      new this.#Key("x", "x", true)
    ];
    
    document.addEventListener("keydown", event => {
      const keyIndex = this.#FindKeyByCode(event.key);
      
      if (keyIndex === -1) return;
      
      event.preventDefault();
      
      this.#keys[keyIndex].active = true;
    });
    document.addEventListener("keyup", event => {
      const keyIndex = this.#FindKeyByCode(event.key);
      
      if (keyIndex === -1) return;
      
      event.preventDefault();
      
      this.#keys[keyIndex].active = false;
    });
  }

  static End () {
    for (let i = 0; i < this.#keys.length; i++) this.#keys[i].lastState = this.#keys[i].active;
  }
  
  static BindButton (button, key) {
    if (this.#buttons.indexOf(button) >= 0 || key < 0 || key >= this.#keys.length) return;

    const bind = this.#keys[key];

    button.addEventListener("touchstart", () => bind.active = true);
    button.addEventListener("touchend", () => bind.active = false);

    this.#buttons.push(button);
  }

  static GetKey (key) {    
    if (key < 0 || key >= this.#keys.length) return;
    
    return this.#keys[key].active;
  }
  
  static GetKeyDown (key) {
    if (key < 0 || key >= this.#keys.length) return;
    
    return this.#keys[key].active && !this.#keys[key].lastState;
  }
  
  static GetKeyUp (key) {    
    if (key < 0 || key >= this.#keys.length) return;
    
    return !this.#keys[key].active && this.#keys[key].lastState;
  }
}


async function Main () {
  document.body.classList.add("change-0");
  bg.classList.add("change-2");
  box.classList.add("change-3");
  diaManager.dialoguePortrait.classList.add("change-4");

  await DialogueLoop.Delay(1);
  await diaManager.SetActive(true);

  RunDia(diaIndex);
}

async function LerpBGVol (value, time) {
  bgLerping = !bgLerping;
  
  const valOffset = value - bgAudio.volume;
  
  let done = false;
  
  await new Promise(resolve => DialogueLoop.Append(() => {
    if (!bgLerping) {
      bgLerping = true;
      done = true;
      
      resolve();
      
      return;
    }
    
    bgAudio.volume += valOffset * (DialogueLoop.deltaTime / time);
    
    if ((valOffset > 0) ? (bgAudio.volume < value) : (bgAudio.volume > value)) return;
    
    bgAudio.volume = value;
    
    bgLerping = false;
    done = true;
    
    resolve();
  }, 0, () => done));
}

async function Type (text, speed, peep, face, delayAfter) {
  const data = new DialogueData({ audio : peep, delayAfter : delayAfter ?? 0 });

  if (face != null) data.portrait = `${peep}/${face}`; 

  await diaManager.Type(text, speed, data);
}

// holy fuck calm you literally made a whole-ass dialogue system-

// nah, i'd rather call it da great        W    A    L    L        of china
// - calm
async function RunDia (index) {
  diaNextValid = false;
  arrow.style.display = "none";

  switch (index) {
    case 0:
      canSkip = true;
      await Type("Hey nerds.", 1, "claire", "neutral");
      break;
    case 1:
      await diaManager.ClearText();
      await Type("It's me, ", 1, "claire", null, 0.75);
      await Type("Claire.", 1, "claire");
      break;
    case 2:
      await diaManager.ClearText();
      await Type("I am now on a poggers website. ", 1, "claire", "happy");
      break;
    case 3:
      await Type("Woo!", 1, "claire");
      break;
    case 4:
      await diaManager.ClearText();
      await Type("Anyways it's time for some fucking debugging.", 1, "claire", "sigh");
      break;
    case 5:
      await diaManager.ClearText();
      await Type("Spax, ", 1, "aimottle", "unsure", 0.67);
      await Type("you don't know what you're doing at all, ", 1, "aimottle", null, 0.5);
      await Type("do you?", 1, "aimottle");
      break;
    case 6:
      await diaManager.ClearText();
      await Type("Well no", 0.67, "spax", "worried");

      canSkip = false;
      await Type("...", 0.02, "spax");
      canSkip = true;

      await Type(" but-", 0.67, "spax");

      (async () => {
        await LerpBGVol(0, 1.2);
        bgAudio.Pause();
      })();

      await diaManager.ClearText();
      
      canSkip = false;
      await Type("...", 0.02, "spax", "pensive");

      await diaManager.SetActive(false);

      await RunScene(0);

      await diaManager.SetActive(true);
      canSkip = true;
      await Type("HOLY SHIT THEY ACTUALLY FIXED MOST OF THE CODE", 1, "aimottle", "neutral");
      break;
    case 7:
      await diaManager.ClearText();
      await Type("how tf-", 0.25, "claire", "aghast");
      await diaManager.ClearText();
      await Type("I have ", 0.5, "spax", "dizzy", 0.5);
      await Type("no clue ", 0.6, "spax", null, 1);
      await Type("how ", 1, "spax", null, 0.67);
      await Type("I did it", 1.24, "spax", null, 0.7);
      await Type("I'm so tired ", 0.36, "spax", null, 1);
      await Type("now", 1, "spax");
      break;
    case 8:
      diaManager.audioSource.volume = 0.4;

      await diaManager.ClearText();
      await Type("(I still don't know where the ", 1, "yoki", "sweat_drop");
      await diaManager.Type("fuck ", 1, new DialogueData({
        audio : "yoki",
        style : new DialogueStyle({ fontStyle : "italic" })
      }));
      await Type("I am-)", 1, "yoki");

      diaManager.audioSource.volume = 0.7;

      await diaManager.ClearText();
      await Type("Wait", 1, "yoki");

      canSkip = false;
      await Type("... ", 0.04, "yoki");
      canSkip = true;

      await Type("I can talk more freely?", 1, "yoki", "surprised");
      break;
    case 9:
      await diaManager.ClearText();
      await Type("Cool right?", 1, "claire", "happy");
      break;
    case 10:
      await diaManager.ClearText();
      await Type("There was going to be more than these dialogues.", 1, "claire", "sigh");
      break;
    case 11:
      await diaManager.ClearText();
      await Type("But we were too busy.", 1, "claire");
      break;
    case 12:
      await diaManager.ClearText();
      await Type("I was getting chased by a wild dog!", 1, "aimottle", "angry");
      break;
    case 13:
      diaManager.soundInterval = 1;

      await diaManager.ClearText();
      await Type("TA", 1, "woof", "awake");
      await Type("AAAA", 0.15, "woof");
      await Type("SSSTTY\nR", 0.3, "woof");
      await Type("AAA", 0.15, "woof");
      await Type("BBIIITT!", 0.07, "woof");

      diaManager.soundInterval = 3;
      skipSInterval = 3;
      break;
    case 14:
      await diaManager.ClearText();
      await Type("About that, ", 1, "aimottle", "unsure", 0.5);
      await Type("I'm gonna go", 1, "aimottle");

      canSkip = false;
      await Type("...", 0.11, "aimottle");
      canSkip = true;

      await Type("and run.", 1, "aimottle", "neutral");
      break;
    case 15:
      await diaManager.ClearText();
      await Type("Wait for me", 1, "yoki", "sweat_drop");

      canSkip = false;
      await Type("...", 0.2, "yoki");
      canSkip = true;
      break;
    case 16:
      await diaManager.ClearText();
      await Type("These boxes looks awful on mobile.", 1, "claire", "sigh");
      break;
    case 17:
      await diaManager.ClearText();
      await Type("Not anymore.", 1, "este", "");

      diaManager.audioSource.volume = 4;

      await diaManager.ClearText();
      await Type("AAAAHH!!", 2, "claire", "aghast");

      diaManager.audioSource.volume = 0.7;

      await diaManager.ClearText();
      await Type("Dude, ", 1, "claire", "mad", 1);
      await Type("don't ", 1, "claire", null, 0.75);
      await Type("do ", 1, "claire", "sigh", 0.5);
      await Type("that.", 1, "claire");
      break;
    case 18:
      await diaManager.ClearText();
      await Type("Do what?", 1, "este", "");
      break;
    case 19:
      await diaManager.ClearText();
      await Type("Sneaking up on people.", 1.2, "claire", "sigh");
      break;
    case 20:
      await diaManager.ClearText();
      await Type("Ok.", 1, "este", "");
      break;
    case 21:
      await diaManager.ClearText();
      await Type("Oh, ", 1, "claire", "neutral", 0.25);
      await Type("I almost forgot.", 1, "claire");
      break;
    case 22:
      await diaManager.ClearText();
      await Type("Happy birthday Spax!", 1, "claire", "happy");
      break;
    case 23:
      await diaManager.ClearText();
      await Type("Aren't you going to greet Spax too?", 1, "claire", "neutral");
      break;
    case 24:
      await diaManager.ClearText();
      await Type("Nope.", 1, "este", "");
      break;
    case 25:
      await diaManager.ClearText();
      await Type("Then why are you here?", 1, "claire", "sigh");
      break;
    case 26:
      await diaManager.ClearText();
      await Type("Work.", 1, "este", "");
      break;
    case 27:
      await diaManager.ClearText();
      await Type("What do you mean work?", 1.2, "claire", "sigh");
      break;
    case 28:
      await diaManager.ClearText();
      await Type("You're not even wearing a bag.", 1, "claire");
      break;
    case 29:
      await diaManager.ClearText();
      await Type("Work.", 1, "este", "");
      break;
    case 30:
      await diaManager.ClearText();
      await Type("You don't have anything with you dude.", 1, "claire", "sigh");
      break;
    case 31:
      await diaManager.ClearText();
      await Type("Wo-", 1, "este", "");

      bgAudio.Stop();

      await diaManager.ClearText();
      await Type("What did I miss?", 1, "zera", "neutral");
      break;
    case 32:
      bgAudio = bgm[1];
      bgAudio.volume = 0.25;
      bgAudio.Play();

      await diaManager.ClearText();
      await Type("Oh, ", 1, "claire", "neutral", 0.62);
      await Type("you.", 1, "claire", "sigh");
      break;
    case 33:
      await diaManager.ClearText();
      await Type("Can you just ", 1, "claire", null, 0.5);
      await Type("leave?", 1, "claire", "mad");
      break;
    case 34:
      await diaManager.ClearText();
      await Type("I want to, ", 1, "zera", "neutral", 0.37);
      await Type("but I also want screen time.", 1, "zera");
      break;
    case 35:
      await diaManager.ClearText();
      await Type("Am I not allowed to have screen time?", 1, "zera", "look");
      break;
    case 36:
      await diaManager.ClearText();
      canSkip = false;
      await Type("...", 0.02, "claire", "aghast");
      canSkip = true;
      break;
    case 37:
      await diaManager.ClearText();
      await Type("Thought so.", 0.68, "zera", "sneer");
      break;
    case 38:
      await diaManager.ClearText();
      await Type("You know what. ", 1, "zera", "neutral");
      break;
    case 39:
      await Type("I'm taking this.", 1, "zera");
      break;
    case 40:
      await diaManager.ClearText();
      await Type("Wait no-", 2, "claire", "aghast");

      await RunScene(1);

      bgAudio = bgm[2];
      bgAudio.volume = 0.25;
      bgAudio.Play();

      canSkip = true;

      await Type("Now I have you, ", 1, "zera", "neutral", 0.37);
      await Type("I can have all the screen time I want.", 1, "zera");
      break;
    case 41:
      await diaManager.ClearText();
      await Type("Anyways, ", 1, "zera", "neutral", 0.37);
      await Type("happy birthday Spax.", 1, "zera", "smile");

      await RunScene(2);

      await diaManager.ClearText();
      await Type("I'm definitely going to send someone to hunt down Calm if he sends this to you late.", 1, "zera", "pout");

      canSkip = false;

      await DialogueLoop.Delay(15);

      canSkip = true;

      await diaManager.ClearText();
      await Type("Zera!", 1, "woof", "awake");
      break;
    case 42:
      await diaManager.ClearText();
      await Type("Have you seen tasty rabbit around?", 0.9, "woof", "look");
      break;
    case 43:
      await diaManager.ClearText();
      await Type("They were with Yoki.", 1, "woof", "look");
      break;
    case 44:
      await diaManager.ClearText();
      await Type("I haven't seen them, ", 1, "zera", "smile", 0.37);
      await Type("you should probably keep looking.", 1, "zera");
      break;
    case 45:
      await diaManager.ClearText();
      await Type("Okay!", 1, "woof", "awake");
      break;
    case 46:
      await diaManager.ClearText();
      await Type("Wait", 1, "woof", "look");
      canSkip = false;
      await Type("...", 0.5, "woof");
      canSkip = true;
      break;
    case 47:
      await diaManager.ClearText();
      await Type("What that weird fish that looks like a lizard?", 1, "woof", "look");
      break;
    case 48:
      await diaManager.ClearText();
      await Type("It's called an axolotl.", 1, "zera", "smile");
      break;
    case 49:
      await diaManager.ClearText();
      await Type("Can I eat it?", 1.5, "woof", "awake");
      break;
    case 50:
      await diaManager.ClearText();
      await Type("It's the axolotl's birthday, ", 1, "zera", "smile", 0.37);
      await Type("so we let it live another day.", 1, "zera");
      break;
    case 51:
      await diaManager.ClearText();
      await Type("Oh, ", 1, "woof", "look", 0.7);
      await Type("I guess I'll just keep on looking.", 1.3, "woof", "awake");
      break;
    case 52:
      await diaManager.ClearText();
      await Type("Happy birthday axolotl!", 1.4, "woof", "awake");
      break;
    case 53:
      canSkip = false;

      await diaManager.ClearText();
      await Type("...", 0.015, "zera", "smile");

      await DialogueLoop.Delay(20);

      canSkip = true;

      await diaManager.ClearText();
      await Type("Here's a gift, ", 1, "zera", "smile", 0.37);
      await Type("it took a lot of effort to make.", 1, "zera", "neutral");

      await RunScene(3);
      //WOWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW
      return;
  }

  diaNextValid = true;
  arrow.style.display = "initial";
}

async function RunScene (index) {
  switch (index) {
    case 0:
      const body = document.body;

      await DialogueLoop.Delay(1.3);

      (async () => {
        se[4].PlayOneShot();
        await DialogueLoop.Delay(0.5);
        se[7].PlayOneShot();
      })();

      body.classList.remove("change-0");
      body.classList.add("change-1");

      await DialogueLoop.Delay(1);

      se[7].PlayOneShot();
      await DialogueLoop.Delay(0.25);
      se[4].PlayOneShot();
      await DialogueLoop.Delay(0.5);
      se[4].PlayOneShot();
      await DialogueLoop.Delay(0.5);
      se[7].PlayOneShot();
      await DialogueLoop.Delay(0.01);
      se[7].PlayOneShot();
      se[4].PlayOneShot();

      body.classList.remove("change-1");

      await DialogueLoop.Delay(2);

      await se[5].Play();

      bg.classList.remove("change-2");

      await DialogueLoop.Delay(0.7);

      se[5].PlayOneShot();
      await DialogueLoop.Delay(0.05);
      se[5].PlayOneShot();
      await DialogueLoop.Delay(0.01);
      se[5].PlayOneShot();
      await DialogueLoop.Delay(0.5);
      await se[6].Play();

      box.classList.remove("change-3");

      se[4].PlayOneShot();

      await DialogueLoop.Delay(1.4);

      se[7].PlayOneShot();

      diaManager.dialoguePortrait.classList.remove("change-4");

      await DialogueLoop.Delay(1);

      bgAudio.Play();
      LerpBGVol(0.25, 0.5);
      break;
    case 1:
      canSkip = false;

      while (diaManager.dialogueLine.firstChild != null) diaManager.dialogueLine.firstChild.remove();

      diaManager.dialoguePortrait.style.display = "none";

      bgAudio.Stop();

      await DialogueLoop.Delay(1.5);
      
      bgs[0].Play();

      let bgXPos = 0;
      let bgYPos = 0;
      let bgSpeed = 1;
      let time = 0;
      let animState = 0;

      await new Promise(resolve => DialogueLoop.Append(
        () => {
          if (time >= 4 && animState < 1) {
            box.style.animation = "shake1 0.25s infinite";
          
            animState++;
          }
          else if (time >= 14 && animState < 2) {
            box.style.animation = "shake2 0.25s infinite";
          
            animState++;
          }
          else if (time >= 20 && animState < 3) {
            box.style.animation = "shake3 0.25s infinite";

            animState++;
          }
          else if (time >= 24 && animState < 4) {
            box.style.animation = "shake4 0.25s infinite";

            animState++;
          }
          else if (time >= 30 && animState < 5) {
            resolve();

            animState++;
          }
          else if (time >= 31 && animState < 6) {
            bgs[0].Stop();

            animState++;
          }

          if (bgs[0].volume < 0.5) bgs[0].volume += bgSpeed * 0.005 * DialogueLoop.deltaTime;
          if (animState === 5) bgs[0].volume -= 0.1 * DialogueLoop.deltaTime;

          if (animState >= 4) {
            bgXPos += bgSpeed * 1000 * DialogueLoop.deltaTime;
            bg.style.backgroundPositionX = `${bgXPos}%`;
          }

          bgYPos -= bgSpeed * 100 * DialogueLoop.deltaTime;
          bg.style.backgroundPositionY = `${bgYPos}%`;

          bgSpeed += 0.25 * DialogueLoop.deltaTime;

          time += DialogueLoop.deltaTime;
        },
        null,
        () => animState === 7
      ));

      await se[0].Play();
      se[1].PlayOneShot();

      animState++;
      box.style.display = "none";
      box.style.animation = "initial";
      bg.style.backgroundImage = "none";
      bg.style.display = "initial";

      box.setAttribute("topped", 1);

      diaManager.Once(DialogueEvent.Disable, () => box.style.display = "");
      diaManager.Finish();
      await diaManager.SetActive(false);

      await DialogueLoop.Delay(1);
      await diaManager.SetActive(true);
      break;
    case 2:
      canSkip = false;

      const newBox = document.createElement("div");
      const boxText = document.createElement("div");

      newBox.style.transform = "scaleY(0)";

      newBox.classList.add("textbox");

      newBox.appendChild(boxText);
      bg.appendChild(newBox);

      requestAnimationFrame(() => {
        newBox.style.transform = "none";
        newBox.style.transition = "transform 0.125s";
      });

      await DialogueLoop.Delay(0.125);

      const homeLink = document.createElement("a");
      homeLink.href = "/";
      homeLink.append("Click here");

      boxText.append("(", homeLink, "  to go back to the main page!)");

      await DialogueLoop.Delay(10);

      canSkip = true;
      break;
    case 3:
      const gift = document.createElement("div");

      const hitbox = document.createElement("div");
      const hitboxes = [
        document.createElement("div"),
        document.createElement("div"),
        document.createElement("div")
      ];
      const trigger = document.createElement("div");

      const cover = document.createElement("div");
      const coverImg = document.createElement("img");
      const base = document.createElement("div");
      const baseImg = document.createElement("img");

      gift.id = "gift";
      hitbox.id = "gift-hitbox";
      trigger.id = "gift-trigger";

      gift.addEventListener("dragstart", event => event.preventDefault());
      hitbox.addEventListener("dragstart", event => event.preventDefault());
      hitboxes[0].addEventListener("dragstart", event => event.preventDefault());
      hitboxes[1].addEventListener("dragstart", event => event.preventDefault());
      hitboxes[2].addEventListener("dragstart", event => event.preventDefault());

      coverImg.src = diaManager.config.sprites.Find("gift_cover").spriteURL;
      baseImg.src = diaManager.config.sprites.Find("gift_base").spriteURL;

      hitbox.append(...hitboxes);
      cover.append(hitbox, coverImg);
      base.append(baseImg);
      gift.append(cover, base, trigger);
      bg.append(gift);

      let dragging = false;
      let triggered = false;
      let x = cover.offsetLeft;
      let y = cover.offsetTop;
      let mouseXOld = 0;
      let mouseYOld = 0;
      let mouseX = 0;
      let mouseY = 0;

      const enableDrag = (x, y) => {
        dragging = true;

        mouseX = x;
        mouseY = y;

        hitbox.setAttribute("dragging", 1);

        cover.style.transform = "scale(112%)";
        cover.style.transition = "transform 0.25s";

        se[2].PlayOneShot();
      };
      const disableDrag = () => {
        dragging = false;

        hitbox.setAttribute("dragging", 0);

        cover.style.transform = "none";
        cover.style.transition = "transform 0.125s ease-in";

        se[3].PlayOneShot();
      };
      const tEnableDrag = event => {
        const touch = event.touches[event.touches.length - 1]

        enableDrag(touch.clientX, touch.clientY);
      };

      hitboxes[0].addEventListener("mousedown", event => enableDrag(event.clientX, event.clientY));
      hitboxes[0].addEventListener("touchstart", event => tEnableDrag(event));
      hitboxes[0].addEventListener("mouseup", () => disableDrag());
      hitboxes[0].addEventListener("touchend", () => disableDrag());
      hitboxes[1].addEventListener("mousedown", event => enableDrag(event.clientX, event.clientY));
      hitboxes[1].addEventListener("touchstart", event => tEnableDrag(event));
      hitboxes[1].addEventListener("mouseup", () => disableDrag());
      hitboxes[1].addEventListener("touchend", () => disableDrag());
      hitboxes[2].addEventListener("mousedown", event => enableDrag(event.clientX, event.clientY));
      hitboxes[2].addEventListener("touchstart", event => tEnableDrag(event));
      hitboxes[2].addEventListener("mouseup", () => disableDrag());
      hitboxes[2].addEventListener("touchend", () => disableDrag());

      const updateMouse = (xPos, yPos) => {
        mouseXOld = mouseX;
        mouseYOld = mouseY;

        mouseX = xPos;
        mouseY = yPos;

        const deltaX = mouseX - mouseXOld;
        const deltaY = mouseY - mouseYOld;

        x += deltaX;
        y += deltaY;

        cover.style.left = `${x}px`;
        cover.style.top = `${y}px`;
      };

      document.addEventListener("mousemove", event => {
        if (dragging) updateMouse(event.clientX, event.clientY);
      });
      document.addEventListener("touchmove", event => {
        if (!dragging) return;

        event.preventDefault();

        const touch = event.touches[event.touches.length - 1];
        
        updateMouse(touch.clientX, touch.clientY);
      }, { passive : false });

      trigger.addEventListener("click", async () => {
        if (triggered) return;

        triggered = true;

        ctrls.style.opacity = "0";
        ctrls.style.transition = "opacity 0.25s";

        trigger.setAttribute("enabled", 1);
        trigger.style.transition = "all ease-out 0.5s";

        (async () => {
          await LerpBGVol(0, 2);
          bgAudio.Stop();
        })();

        (async () => {
          await DialogueLoop.Delay(0.037);

          canSkip = false;

          diaManager.audioSource.volume = 0.4;

          await diaManager.ClearText();
          await Type("LMAAAAAAOOOOOOOOOOO", 2, "zera", "smile");
        })();

        await DialogueLoop.Delay(0.5);

        trigger.style.transition = "initial";

        await DialogueLoop.Delay(2.5);

        const video = document.createElement("video");
        const source = document.createElement("source");

        video.volume = 0.5;
        video.autoplay = true;
        source.src = giftVid;

        video.append(source);
        trigger.append(video);
      });
      break;
  }
}


Input.Init();
Input.BindButton(ctrlX, 1);
Input.BindButton(ctrlZ, 0);


DialogueLoop.Append(() => {
  if (document.hasFocus() && document.fullscreenElement == null) document.documentElement.requestFullscreen();

  if (Input.GetKeyDown(0)) ctrlZ.style.transform = "translateY(4%)";
  else if (Input.GetKeyUp(0)) ctrlZ.style.transform = "initial";

  if (Input.GetKeyDown(1)) ctrlX.style.transform = "translateY(4%)";
  else if (Input.GetKeyUp(1)) ctrlX.style.transform = "initial";

  if (Input.GetKeyDown(0) && diaNextValid) {
    diaIndex++;

    RunDia(diaIndex);
  }
  if (Input.GetKey(1) && !diaNextValid && skipIndex === 0) skipIndex = 1;

  if (skipIndex > 0) {
    if (diaNextValid || !canSkip) {
      if (skipIndex === 2) diaManager.soundInterval = skipSInterval;

      skipIndex = 0;
      skipHasAudio = false;
    }
    else if (skipIndex === 2) {
      const chars = diaManager.characters;

      for (let i = 0; i < chars.length; i++) {
        if (chars[i].audio == null) continue;

        if (!skipHasAudio && chars[i].audio != null) {
          skipHasAudio = true;
          
          continue;
        }

        chars[i].audio = null;
      }

      diaManager.Finish();
    }
    else {
      skipIndex = 2;

      skipSInterval = diaManager.soundInterval;
      diaManager.soundInterval = 1;
    }
  }

  Input.End();
});

diaManager.Once(DialogueEvent.Load, async () => {
  let loaded = false;

  const vid = await fetch("https://calmbubbles.github.io/zerasGift/video/watchtillend.mp4");
  const vidBlob = await vid.blob();
  
  giftVid = await URL.createObjectURL(vidBlob);

  DialogueLoop.Append(
    async () => {
      for (let i = 0; i < bgm.length; i++) if (!bgm[i].isLoaded) return;
      
      for (let i = 0; i < bgs.length; i++) if (!bgs[i].isLoaded) return;

      for (let i = 0; i < me.length; i++) if (!me[i].isLoaded) return;

      for (let i = 0; i < se.length; i++) if (!se[i].isLoaded) return;
      
      loaded = true;

      tipText.style.opacity = 0;

      await DialogueLoop.Delay(0.5);

      loading.remove();

      tipText.append("Interact with the page");
      tipText.style.opacity = 1;

      tip.onclick = async () => {
        tip.onclick = () => { };
        
        tip.style.opacity = "0";
        
        bgAudio = bgm[0];
        bgAudio.volume = 0;
        bgAudio.Play();
        LerpBGVol(0.25, 1);
        
        await DialogueLoop.Delay(0.5);
        
        tip.remove();

        (async () => {
          await DialogueLoop.Delay(1.5);

          ctrltext.style.opacity = "0";
          
          await DialogueLoop.Delay(0.25);
          
          ctrltext.remove();
        })();
        
        Main();
      };

      await DialogueLoop.Delay(0.5);

      tipText.style.animation = "linear fade 1s infinite";
    },
    null,
    () => loaded
  );
});

diaManager.On(DialogueEvent.TypingEnter, () => {
  if (!bgLerping) bgAudio.volume = 0.125;

  const chars = diaManager.characters.filter(item => !item.isEnabled && item.audio != null);

  if (skipHasAudio) chars[0].audio = null;
});

diaManager.On(DialogueEvent.TypingExit, () => { if (!bgLerping) bgAudio.volume = 0.25; });

    </script>
  </body>
</html>